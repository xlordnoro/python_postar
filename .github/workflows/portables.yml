name: Build Portable Python App

on:
  release:
    types: [created]  # Trigger when a new release is created

permissions:
  contents: write  # Needed for uploading release assets

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: [3.13.9]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        # Navigate to src folder
        cd src
        pyinstaller --onedir python_postar.py

    - name: Package dist folder
      run: |
        OS_NAME="${{ matrix.os }}"
        DIST_FOLDER="src/dist"
        # Remove "latest-" from OS name for nicer zip names
        case "$OS_NAME" in
          ubuntu-latest) PLATFORM="linux" ;;
          windows-latest) PLATFORM="windows" ;;
          macos-latest) PLATFORM="macos" ;;
        esac
        ZIP_NAME="python_postar_${PLATFORM}_v${GITHUB_REF_NAME}_portable.zip"

        # Windows uses PowerShell for zipping
        if [[ "$OS_NAME" == "windows-latest" ]]; then
          powershell Compress-Archive -Path $DIST_FOLDER\* -DestinationPath $ZIP_NAME
        else
          zip -r $ZIP_NAME $DIST_FOLDER
        fi

    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        files: python_postar_${PLATFORM}_v${GITHUB_REF_NAME}_portable.zip
