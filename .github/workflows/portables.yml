name: Build Portable Python App

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.14.2

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 PyQt6-WebEngine requests pymediainfo

      # -------------------------------
      # Build Windows EXEs
      # -------------------------------
      - name: Build Python script EXE
        shell: pwsh
        run: |
          cd src
          pyinstaller --clean --onedir --icon=../icon.ico python_postar.py

      - name: Build GUI EXE
        shell: pwsh
        run: |
          cd src
          pyinstaller --clean --onefile --windowed --add-data "../css;css" --icon=../icon.ico gui.pyw -n python_postar_gui

      - name: Build Updater GUI EXE
        shell: pwsh
        run: |
          cd src
          pyinstaller --clean --onefile --icon=../icon.ico updater.py -n updater

      # -------------------------------
      # Prepare portable folder
      # -------------------------------
      - name: Prepare portable folder
        shell: pwsh
        run: |
          $STAGE = "src\dist\python_postar_portable"
          New-Item -ItemType Directory -Force -Path "$STAGE\scripts"
          New-Item -ItemType Directory -Force -Path "$STAGE\css"
          Copy-Item -Recurse src\dist\python_postar\* "$STAGE\"
          Copy-Item src\dist\python_postar_gui.exe "$STAGE\"
          Copy-Item src\dist\updater.exe "$STAGE\"
          Copy-Item icon.ico "$STAGE\"
          Copy-Item -Recurse guides "$STAGE\"
          Copy-Item -Recurse css "$STAGE\css\"
          Copy-Item scripts\postar_batch_portable.bat "$STAGE\scripts\"

      - name: Package portable ZIP
        shell: pwsh
        run: |
          $DIST_FOLDER = "src\dist\python_postar_portable"
          $ZIP_NAME = "python_postar_windows_${env:GITHUB_REF_NAME}_portable.zip"
          Compress-Archive -Path "$DIST_FOLDER\*" -DestinationPath $ZIP_NAME -Force
          Write-Host "Created $ZIP_NAME"

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: python_postar_windows_${{ github.ref_name }}_portable.zip

  build-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.14.2

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 PyQt6-WebEngine requests pymediainfo

      # -------------------------------
      # Build Linux binaries
      # -------------------------------
      - name: Build binaries
        shell: bash
        run: |
          cd src
          pyinstaller --clean --onedir python_postar.py
          pyinstaller --clean --onefile --add-data "../css:css" --windowed gui.pyw -n python_postar_gui
          pyinstaller --clean --onefile updater.py -n updater

      - name: Prepare portable folder
        shell: bash
        run: |
          STAGE="src/dist/python_postar_portable"
          mkdir -p "$STAGE/scripts"
          cp -r src/dist/python_postar/* "$STAGE/"
          cp src/dist/python_postar_gui "$STAGE/"
          cp src/dist/updater "$STAGE/"
          cp scripts/postar_batch_linux_portable.sh "$STAGE/scripts/"
          chmod +x "$STAGE/scripts/postar_batch_linux_portable.sh"
          cp icon_linux.png "$STAGE/"
          cp -r guides "$STAGE/"
          cp -r css "$STAGE/"
          printf '%s\n' \
            '[Desktop Entry]' \
            'Type=Application' \
            'Name=Python Postar (Portable)' \
            'Exec=./python_postar' \
            'Icon=./icon_linux.png' \
            'Terminal=true' \
            'Categories=Utility;' \
            > "$STAGE/python_postar.desktop"
          chmod +x "$STAGE/python_postar.desktop"

      - name: Package portable ZIP
        shell: bash
        run: |
          cd src/dist/python_postar_portable || exit 1
          zip -r "../../../python_postar_linux_${GITHUB_REF_NAME}_portable.zip" .
          echo "Created python_postar_linux_${GITHUB_REF_NAME}_portable.zip"

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: python_postar_linux_${{ github.ref_name }}_portable.zip

  build-macos-x86_64:
    runs-on: macos-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.14.2

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 PyQt6-WebEngine requests pymediainfo

      - name: Build binaries
        shell: bash
        run: |
          cd src
          pyinstaller --clean --onedir python_postar.py
          pyinstaller --clean --onefile --add-data "../css:css" --windowed gui.pyw -n python_postar_gui
          pyinstaller --clean --onefile updater.py -n updater

      - name: Prepare portable folder
        shell: bash
        run: |
          STAGE="src/dist/python_postar_portable"
          mkdir -p "$STAGE/scripts"
          cp -r src/dist/python_postar/* "$STAGE/"
          cp src/dist/python_postar_gui "$STAGE/"
          cp src/dist/updater "$STAGE/"
          cp scripts/postar_batch_linux_portable.sh "$STAGE/scripts/"
          chmod +x "$STAGE/scripts/postar_batch_linux_portable.sh"
          cp icon_linux.png "$STAGE/"
          cp -r guides "$STAGE/"
          cp -r css "$STAGE/"

      - name: Package portable ZIP
        shell: bash
        run: |
          cd src/dist/python_postar_portable || exit 1
          zip -r "../../../python_postar_macos_x86_64_${GITHUB_REF_NAME}_portable.zip" .
          echo "Created python_postar_macos_x86_64_${GITHUB_REF_NAME}_portable.zip"

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: python_postar_macos_x86_64_${{ github.ref_name }}_portable.zip

  build-macos-arm64:
    runs-on: macos-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.14.2

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 PyQt6-WebEngine requests pymediainfo

      - name: Build binaries
        shell: bash
        run: |
          cd src
          pyinstaller --clean --onedir python_postar.py
          pyinstaller --clean --onefile --add-data "../css:css" --windowed gui.pyw -n python_postar_gui
          pyinstaller --clean --onefile updater.py -n updater

      - name: Prepare portable folder
        shell: bash
        run: |
          STAGE="src/dist/python_postar_portable"
          mkdir -p "$STAGE/scripts"
          cp -r src/dist/python_postar/* "$STAGE/"
          cp src/dist/python_postar_gui "$STAGE/"
          cp src/dist/updater "$STAGE/"
          cp scripts/postar_batch_linux_portable.sh "$STAGE/scripts/"
          chmod +x "$STAGE/scripts/postar_batch_linux_portable.sh"
          cp icon_linux.png "$STAGE/"
          cp -r guides "$STAGE/"
          cp -r css "$STAGE/"

      - name: Package portable ZIP
        shell: bash
        run: |
          cd src/dist/python_postar_portable || exit 1
          zip -r "../../../python_postar_macos_arm64_${GITHUB_REF_NAME}_portable.zip" .
          echo "Created python_postar_macos_arm64_${GITHUB_REF_NAME}_portable.zip"

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: python_postar_macos_arm64_${{ github.ref_name }}_portable.zip

  build-arch-portable:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    container:
      image: archlinux:latest
    steps:
      - name: Install system dependencies
        run: |
          pacman -Sy --noconfirm python python-pip python-virtualenv zip patchelf base-devel

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build binaries (venv)
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install pyinstaller PyQt6 PyQt6-WebEngine requests pymediainfo

          cd src
          pyinstaller --clean --onedir python_postar.py
          pyinstaller --clean --onefile --add-data "../css:css" --windowed gui.pyw -n python_postar_gui
          pyinstaller --clean --onefile updater.py -n updater

      - name: Prepare portable folder
        run: |
          STAGE="src/dist/python_postar_portable"
          mkdir -p "$STAGE/scripts"
          cp -r src/dist/python_postar/* "$STAGE/"
          cp src/dist/python_postar_gui "$STAGE/"
          cp src/dist/updater "$STAGE/"
          cp scripts/postar_batch_linux_portable.sh "$STAGE/scripts/"
          chmod +x "$STAGE/scripts/postar_batch_linux_portable.sh"
          cp icon_linux.png "$STAGE/"
          cp -r guides "$STAGE/"
          cp -r css "$STAGE/"
          printf '%s\n' \
            '[Desktop Entry]' \
            'Type=Application' \
            'Name=Python Postar (Portable)' \
            'Exec=./python_postar' \
            'Icon=./icon_linux.png' \
            'Terminal=true' \
            'Categories=Utility;' \
            > "$STAGE/python_postar.desktop"
          chmod +x "$STAGE/python_postar.desktop"

      - name: Package portable ZIP
        run: |
          cd src/dist/python_postar_portable || exit 1
          zip -r "../../../python_postar_linux_arch_${GITHUB_REF_NAME}_portable.zip" .
          echo "Created python_postar_linux_arch_${GITHUB_REF_NAME}_portable.zip"

      - name: Upload Arch portable asset
        uses: softprops/action-gh-release@v2
        with:
          files: python_postar_linux_arch_${{ github.ref_name }}_portable.zip
