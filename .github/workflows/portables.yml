name: Build Portable Python App

on:
  release:
    types: [created]

permissions:
  contents: write  # required for uploading release assets

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: [3.13.9]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller requests pymediainfo

    - name: Build with PyInstaller
      run: |
        cd src
        pyinstaller --clean --onedir --icon=../icon.ico python_postar.py

    - name: Add extra files to portable build
      shell: bash
      run: |
        DIST="src/dist/python_postar"
        mkdir -p "$DIST/scripts"

        # Guides folder
        cp -r guides "$DIST/"

        # Platform-specific scripts
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          cp scripts/postar_batch_portable.bat "$DIST/scripts/"
        else
          # Linux/macOS batch script
          cp scripts/postar_batch_linux_portable.sh "$DIST/scripts/"
          chmod +x "$DIST/scripts/postar_batch_linux_portable.sh"

          if [[ "$RUNNER_OS" == "Linux" ]]; then
            # Add PNG icon (repo root -> src relative)
            cp icon_linux.png "$DIST/"

            # Generate .desktop file using tabs for indentation
            printf '%s\n' \
              '[Desktop Entry]' \
              'Type=Application' \
              'Name=Python Postar' \
              'Exec=./python_postar' \
              'Icon=./icon_linux.png' \
              'Terminal=true' \
              'Categories=Utility;' \
              > "$DIST/python_postar.desktop"

            # Make the .desktop file executable
            chmod +x "$DIST/python_postar.desktop"
          fi
        fi

    - name: Package dist folder
      shell: pwsh
      run: |
        if ($env:RUNNER_OS -eq "Windows") {
            $DIST_FOLDER = "src\dist\python_postar"
            $ZIP_NAME = "python_postar_windows_${env:GITHUB_REF_NAME}_portable.zip"
            Compress-Archive -Path "$DIST_FOLDER\*" -DestinationPath $ZIP_NAME
            Write-Host "Created $ZIP_NAME"
        } else {
            bash -c '
              DIST_FOLDER="src/dist/python_postar"
              if [[ "$RUNNER_OS" == "Linux" ]]; then
                ZIP_NAME="python_postar_linux_${GITHUB_REF_NAME}_portable.zip"
              else
                ZIP_NAME="python_postar_macos_${GITHUB_REF_NAME}_portable.zip"
              fi
        
              cd "$DIST_FOLDER" || exit 1
              zip -r "../../../$ZIP_NAME" .
              echo "Created $ZIP_NAME"
            '
        }

    - name: Upload release asset
      uses: softprops/action-gh-release@v2
      with:
        files: |
          python_postar_windows_${{ github.ref_name }}_portable.zip
          python_postar_linux_${{ github.ref_name }}_portable.zip
          python_postar_macos_${{ github.ref_name }}_portable.zip
