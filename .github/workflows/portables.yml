name: Build Portable Python App

on:
  release:
    types: [created]

permissions:
  contents: write  # required for uploading release assets

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: [3.13.9]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        cd src
        pyinstaller --onedir python_postar.py

    - name: Package dist folder
      shell: pwsh
      run: |
        if ($env:RUNNER_OS -eq "Windows") {
            $DIST_FOLDER = "src\dist"
            $PLATFORM = "windows"
            $ZIP_NAME = "python_postar_${PLATFORM}_v${env:GITHUB_REF_NAME}_portable.zip"
            Compress-Archive -Path "$DIST_FOLDER\*" -DestinationPath $ZIP_NAME
        } else {
            # Linux or macOS
            DIST_FOLDER="src/dist"
            if ($env:RUNNER_OS -eq "Linux") { PLATFORM="linux" }
            else { PLATFORM="macos" }
            ZIP_NAME="python_postar_${PLATFORM}_v${env:GITHUB_REF_NAME}_portable.zip"
            bash -c "zip -r $ZIP_NAME $DIST_FOLDER"
        }

    - name: Upload release asset
      uses: softprops/action-gh-release@v2
      with:
        files: |
          python_postar_windows_v${{ github.ref_name }}_portable.zip
          python_postar_linux_v${{ github.ref_name }}_portable.zip
          python_postar_macos_v${{ github.ref_name }}_portable.zip
