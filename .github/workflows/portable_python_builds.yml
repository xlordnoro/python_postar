name: Build Portable Python 3.13.9 (Python-only)

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.13.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.9"

      - name: Create portable folder structure
        shell: bash
        run: |
          mkdir -p dist/python_portable/Lib/site-packages

      # ---------------- WINDOWS ----------------
      - name: Windows embedded Python 3.13.9
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Download official embedded Python zip
          curl -L https://www.python.org/ftp/python/3.13.9/python-3.13.9-embed-amd64.zip -o python.zip
          Expand-Archive python.zip dist/python_portable/python
          Add-Content dist/python_portable/python/python313._pth "`nimport site"
          # Install Python packages into portable Lib
          python -m pip install --upgrade pip
          python -m pip install requests pymediainfo --target dist/python_portable/Lib/site-packages

      # ---------------- macOS ----------------
      - name: macOS portable Python 3.13.9
        if: runner.os == 'macOS'
        shell: bash
        run: |
          PYROOT=$(python3 - <<'END_PY'
          import sys, pathlib
          print(pathlib.Path(sys.executable).parents[2])
          END_PY
          )
          
          cp -R "$PYROOT" dist/python_portable/python
          python3 -m pip install --upgrade pip
          python3 -m pip install requests pymediainfo --target dist/python_portable/Lib/site-packages

      # ---------------- LINUX ----------------
      - name: Linux portable Python 3.13.9
        if: runner.os == 'Linux'
        shell: bash
        run: |
          PYROOT=$(python3 - <<'END_PY'
          import sys, pathlib
          print(pathlib.Path(sys.executable).parents[2])
          END_PY
          )
          
          cp -R "$PYROOT" dist/python_portable/python
          python3 -m pip install --upgrade pip
          python3 -m pip install requests pymediainfo --target dist/python_portable/Lib/site-packages

      # ---------------- COPY APP SOURCE ----------------
      - name: Copy application entry
        shell: bash
        run: |
          cp src/main.py dist/python_portable/

      # ---------------- CLEANUP ----------------
      - name: Cleanup runtime bloat
        shell: bash
        run: |
          find dist/python_portable -name "__pycache__" -type d -exec rm -rf {} +
          rm -rf dist/python_portable/Lib/site-packages/pip* setuptools* wheel*

      # ---------------- LAUNCHERS ----------------
      - name: Create Unix launcher
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cat << 'EOF' > dist/python_portable/run.sh
          
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          "$DIR/python/bin/python3" "$DIR/main.py" "$@"
          EOF
          
          chmod +x dist/python_portable/run.sh

      - name: Create Windows launcher
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo @echo off > dist\python_portable\run.bat
          echo python\python.exe main.py %* >> dist\python_portable\run.bat

      # ---------------- PACKAGE ----------------
      - name: Package portable build
        shell: bash
        run: |
          cd dist
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            7z a python_portable-windows-py3.13.9.zip python_portable
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            tar -czf python_portable-macos-py3.13.9.tar.gz python_portable
          else
            tar -czf python_portable-linux-py3.13.9.tar.gz python_portable
          fi

      # ---------------- UPLOAD ----------------
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
