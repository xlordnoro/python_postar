name: Build Portable Python 3.13.9 with Scripts

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.13.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.9"

      - name: Create portable folder structure
        shell: bash
        run: |
          mkdir -p dist/python_portable/Lib/site-packages
          mkdir -p dist/python_portable/scripts

      # ---------------- COPY COMMON FILES ----------------
      - name: Copy application files
        shell: bash
        run: |
          cp src/python_postar.py dist/python_portable/
          cp src/helper.py dist/python_portable/
          cp requirements.txt dist/python_portable/
          cp -r guides dist/python_portable/

      # ---------------- WINDOWS ----------------
      - name: Windows portable Python
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          curl -L https://www.python.org/ftp/python/3.13.9/python-3.13.9-embed-amd64.zip -o python.zip
          Expand-Archive python.zip dist/python_portable/python
          Add-Content dist/python_portable/python/python313._pth "`nimport site"

      - name: Create Windows installer scripts
        if: runner.os == 'Windows'
        shell: bash
        run: |
          # Create main batch launcher
          echo "@echo off" > dist/python_portable/scripts/postar_batch.bat
          echo "REM Add your main script commands here" >> dist/python_portable/scripts/postar_batch.bat
          
          # Create install_deps.bat
          cat <<'EOF' > dist/python_portable/scripts/install_deps.bat
          @echo off
          SET PORTABLE_DIR=%~dp0\..
          SET PYTHON_EXE=%PORTABLE_DIR%\python\python.exe
          
          IF NOT EXIST "%PYTHON_EXE%" (
              echo ERROR: Python executable not found at "%PYTHON_EXE%"
              pause
              exit /b 1
          )
          
          echo Upgrading pip...
          "%PYTHON_EXE%" -m ensurepip
          "%PYTHON_EXE%" -m pip install --upgrade pip
          
          echo Installing requests and pymediainfo...
          "%PYTHON_EXE%" -m pip install requests pymediainfo --target "%PORTABLE_DIR%\Lib\site-packages"
          
          echo Installation complete!
          pause
          EOF

      # ---------------- LINUX ----------------
      - name: Linux portable Python
        if: runner.os == 'Linux'
        shell: bash
        run: |
          PYROOT=$(python3 - <<'END_PY'
          import sys, pathlib
          print(pathlib.Path(sys.executable).parents[2])
          END_PY
          )
          cp -R "$PYROOT" dist/python_portable/python

          # Create main shell launcher
          cat <<'EOF' > dist/python_portable/scripts/postar_batch_linux.sh
          #!/bin/bash
          # Add your main script commands here
          EOF
          chmod +x dist/python_portable/scripts/postar_batch_linux.sh

          # Create install_deps.sh
          cat <<'EOF' > dist/python_portable/scripts/install_deps.sh
          #!/bin/bash
          PORTABLE_DIR="$(cd "$(dirname "$0")"/.. && pwd)"
          PYTHON_EXE="$PORTABLE_DIR/python/bin/python3"
          
          if [ ! -f "$PYTHON_EXE" ]; then
            echo "ERROR: Python executable not found at $PYTHON_EXE"
            exit 1
          fi
          
          echo "Upgrading pip..."
          "$PYTHON_EXE" -m ensurepip
          "$PYTHON_EXE" -m pip install --upgrade pip
          
          echo "Installing requests and pymediainfo..."
          "$PYTHON_EXE" -m pip install requests pymediainfo --target "$PORTABLE_DIR/Lib/site-packages"
          
          echo "Installation complete!"
          EOF
          chmod +x dist/python_portable/scripts/install_deps.sh

      # ---------------- macOS ----------------
      - name: macOS portable Python
        if: runner.os == 'macOS'
        shell: bash
        run: |
          PYROOT=$(python3 - <<'END_PY'
          import sys, pathlib
          print(pathlib.Path(sys.executable).parents[2])
          END_PY
          )
          cp -R "$PYROOT" dist/python_portable/python

          # Create main shell launcher
          cat <<'EOF' > dist/python_portable/scripts/postar_batch_linux.sh
          #!/bin/bash
          # Add your main script commands here
          EOF
                    chmod +x dist/python_portable/scripts/postar_batch_linux.sh
          
                    # Create install_deps.sh
                    cat <<'EOF' > dist/python_portable/scripts/install_deps.sh
          #!/bin/bash
          PORTABLE_DIR="$(cd "$(dirname "$0")"/.. && pwd)"
          PYTHON_EXE="$PORTABLE_DIR/python/bin/python3"
          
          if [ ! -f "$PYTHON_EXE" ]; then
            echo "ERROR: Python executable not found at $PYTHON_EXE"
            exit 1
          fi
          
          echo "Upgrading pip..."
          "$PYTHON_EXE" -m ensurepip
          "$PYTHON_EXE" -m pip install --upgrade pip
          
          echo "Installing requests and pymediainfo..."
          "$PYTHON_EXE" -m pip install requests pymediainfo --target "$PORTABLE_DIR/Lib/site-packages"
          
          echo "Installation complete!"
          EOF
          chmod +x dist/python_portable/scripts/install_deps.sh

      # ---------------- CLEANUP ----------------
      - name: Cleanup runtime bloat
        shell: bash
        run: |
          find dist/python_portable -name "__pycache__" -type d -exec rm -rf {} +
          rm -rf dist/python_portable/Lib/site-packages/pip* setuptools* wheel*

      # ---------------- LAUNCHERS ----------------
      - name: Create Windows launcher
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          '@echo off' | Out-File -Encoding ASCII dist\python_portable\run.bat
          'scripts\postar_batch.bat %*' | Out-File -Encoding ASCII -Append dist\python_portable\run.bat

      - name: Create Unix launcher
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cat <<'EOF' > dist/python_portable/run.sh
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          "$DIR/scripts/postar_batch_linux.sh" "$@"
          EOF
          chmod +x dist/python_portable/run.sh

      # ---------------- PACKAGE ----------------
      - name: Package portable build
        shell: bash
        run: |
          cd dist
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            7z a python_postar_windows_${{ github.ref_name }}_portable.zip python_portable
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            tar -czf python_postar_macos_${{ github.ref_name }}_portable.tar.gz python_portable
          else
            tar -czf python_postar_linux_${{ github.ref_name }}_portable.tar.gz python_portable
          fi

      # ---------------- UPLOAD ----------------
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
